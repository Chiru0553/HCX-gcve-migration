locals {
  segment_values = { for name, config in var.segments : name => {
    segment_name        = config.segment_name
    private_cloud       = config.private_cloud
    connectivity        = config.connectivity_path
    cidr                = config.cidr
    connectivity_status = config.connectivity_status
    }
  }
}

data "nsxt_policy_tier1_gateway" "tier1_router" {
  for_each         = local.segment_values
   display_name = each.value.connectivity
}

resource "nsxt_policy_segment" "default" {
  for_each            = local.segment_values
  #name               = each.key
  display_name        = each.value.segment_name
  description         = "VM segment for the Application VMs"
  connectivity_path   = data.nsxt_policy_tier1_gateway.tier1_router[each.key].path
  transport_zone_path = data.nsxt_policy_transport_zone.overlay_tz.path

  subnet {
	cidr    	= "${each.value.cidr}"
	}

  advanced_config {
	connectivity    = "${each.value.connectivity_status}"
	}
}