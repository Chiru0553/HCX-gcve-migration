#################################### Nic - 3 #########################################

## Security zone ew-ebe-npd-mtl-shared-nonopt-ex

## Create Palo Tier-1

resource "nsxt_policy_tier1_gateway" "npd_nic3_router" {
  description           	= "Tier-1 Logical router for security zone ew-ebe-npd-mtl-shared-nonopt-ext "
  display_name          	= "t1-ew-ebe-npd-mtl-shared-nonopt-ext"
  nsx_id          	        = "t1-ew-ebe-npd-mtl-shared-nonopt-ext"
  edge_cluster_path     	= data.nsxt_policy_edge_cluster.edge-cluster.path
  failover_mode         	= "NON_PREEMPTIVE"
  default_rule_logging  	= "false"
  enable_firewall       	= "true"
  enable_standby_relocation = "false"

#   tier0_path            	= data.nsxt_policy_tier0_gateway.tier0_gw_gateway.path
#  route_advertisement_types = [ "TIER1_CONNECTED"]
  pool_allocation       	= "ROUTING"

  tag {
	scope = "security_zone"
	tag   = "t1-ew-ebe-npd-mtl-shared-nonopt-ext"
  }
  
  tag {
	scope = "firewall"
	tag   = "ew-ebe-npd01"
 }

}

## Create Palo Segment

resource "nsxt_policy_segment" "npd_nic3_router_segment" {
  display_name    	= "ls-gne1pc01-pa-npd01-nic3"
  description     	= "Downlink segment for the security zone under FW-NONPROD-MONTREAL-1"
  #connectivity_path   = nsxt_policy_tier1_gateway.npd_nic3_router.path
  transport_zone_path = data.nsxt_policy_transport_zone.overlay_tz.path

  discovery_profile {
    mac_discovery_profile_path = "/infra/mac-discovery-profiles/macdiscovery_profile"
  }
  advanced_config {
	connectivity    = "OFF"
	}
}

## Create Service Interface on PaloTier-1 to Palo Segment

resource "nsxt_policy_tier1_gateway_interface" "npd_nic3_router_svcInterface" {
  display_name           = "npd_nic3_router_svcInterface"
  description            = "Service Connection to Palo t1-ew-ebe-npdx-mtl-shared-nonopt-ext"
  gateway_path           = nsxt_policy_tier1_gateway.npd_nic3_router.path
  segment_path           = nsxt_policy_segment.npd_nic3_router_segment.path
  subnets                = ["10.153.12.145/29"]
  #mtu                    = 1500
  #ipv6_ndra_profile_path = data.nsxt_policy_ipv6_ndra_profile.slaac.path
}


## Create Static Route on Palo Tier-1 to Palo VM using Service Interface

resource "nsxt_policy_static_route" "npd_nic3_router_staticroute" {
  display_name = "npd_nic3_router_staticroute"
  gateway_path = nsxt_policy_tier1_gateway.npd_nic3_router.path
  network      = "0.0.0.0/0"

  next_hop {
    admin_distance = "1"
    ip_address     = "10.153.12.146"
	interface      =  nsxt_policy_tier1_gateway_interface.npd_nic3_router_svcInterface.path
  }
  }


####################################### nic - 4 #######################################

## Security zone ew-eos-npd-lcl-mtl-ignio-nonopt

## Create Palo Alto Tier-1

resource "nsxt_policy_tier1_gateway" "npd_nic4_router" {
  description           	= "Tier-1 Logical router for security zone ew-eos-npd-lcl-mtl-ignio-nonopt"
  display_name          	= "t1-ew-eos-npd-lcl-mtl-ignio-nonopt"
  nsx_id          	        = "t1-ew-eos-npd-lcl-mtl-ignio-nonopt"
  edge_cluster_path     	= data.nsxt_policy_edge_cluster.edge-cluster.path
  failover_mode         	= "NON_PREEMPTIVE"
  default_rule_logging  	= "false"
  enable_firewall       	= "true"
  enable_standby_relocation = "false"
  
  # tier0_path            	= data.nsxt_policy_tier0_gateway.tier0_gw_gateway.path
  #route_advertisement_types = [ "TIER1_CONNECTED"]
  pool_allocation       	= "ROUTING"

  tag {
	scope = "security_zone"
	tag   = "t1-ew-eos-npd-lcl-mtl-ignio-nonopt"
  }
  tag {
	scope = "firewall"
	tag   = "ew-eos-npd01"
 }
}

## Create Palo Segment

resource "nsxt_policy_segment" "npd_nic4_router_segment" {
  display_name    	= "ls-gne1pc01-pa-npd01-nic4"
  description     	= "Downlink segment for the security zone under FW-NONPROD-MONTREAL-1"
  #connectivity_path   = nsxt_policy_tier1_gateway.npd_nic4_router.path
  transport_zone_path = data.nsxt_policy_transport_zone.overlay_tz.path

  discovery_profile {
    mac_discovery_profile_path = "/infra/mac-discovery-profiles/macdiscovery_profile"
  }
  advanced_config {
	connectivity    = "OFF"
	}
}


## Create Service Interface on PaloTier-1 to Palo Segment

resource "nsxt_policy_tier1_gateway_interface" "npd_nic4_router_svcInterface" {
  display_name           = "npd_nic4_router_svcInterface"
  description            = "Service Connection to Palo t1-ew-eos-npd-lcl-mtl-ignio-nonopt"
  gateway_path           = nsxt_policy_tier1_gateway.npd_nic4_router.path
  segment_path           = nsxt_policy_segment.npd_nic4_router_segment.path
  subnets                = ["10.153.12.153/29"]
  #mtu                    = 1500
  #ipv6_ndra_profile_path = data.nsxt_policy_ipv6_ndra_profile.slaac.path
}


## Create Static Route on Palo Tier-1 to Palo VM using Service Interface

resource "nsxt_policy_static_route" "npd_nic4_router_staticroute" {
  display_name = "npd_nic4_router_staticroute"
  gateway_path = nsxt_policy_tier1_gateway.npd_nic4_router.path
  network      = "0.0.0.0/0"

  next_hop {
    admin_distance = "1"
    ip_address     = "10.153.12.154"
	interface      =  nsxt_policy_tier1_gateway_interface.npd_nic4_router_svcInterface.path
  }
  }
