#################################### Nic - 3 #########################################

## Security zone ew-ebe-ppd-mtl-shared-nonopt-ex

## Create Palo Tier-1

resource "nsxt_policy_tier1_gateway" "ppd_nic3_router" {
  description           	= "Tier-1 Logical router for security zone t1-atip-bo-stg-nonopt-ext "
  display_name          	= "t1-atip-bo-stg-nonopt-ext"
  nsx_id          	        = "t1-atip-bo-stg-nonopt-ext"
  edge_cluster_path     	= data.nsxt_policy_edge_cluster.edge-cluster.path
  failover_mode         	= "NON_PREEMPTIVE"
  default_rule_logging  	= "false"
  enable_firewall       	= "true"
  enable_standby_relocation = "false"

#   tier0_path            	= data.nsxt_policy_tier0_gateway.tier0_gw_gateway.path
#  route_advertisement_types = [ "TIER1_CONNECTED"]
  pool_allocation       	= "ROUTING"

  tag {
	scope = "security_zone"
	tag   = "t1-atip-bo-stg-nonopt-ext"
  }
  
  tag {
	scope = "firewall"
	tag   = "atip-bo-stg"
 }

}

## Create Palo Segment

resource "nsxt_policy_segment" "ppd_nic3_router_segment" {
  display_name    	= "ls-gne1pc01-pa-ppd01-nic3"
  description     	= "Downlink segment for the security zone under FW-PPD-MONTREAL-1"
  #connectivity_path   = nsxt_policy_tier1_gateway.ppd_nic3_router.path
  transport_zone_path = data.nsxt_policy_transport_zone.overlay_tz.path

  discovery_profile {
    mac_discovery_profile_path = "/infra/mac-discovery-profiles/macdiscovery_profile"
  }
  advanced_config {
	connectivity    = "OFF"
	}
}

## Create Service Interface on PaloTier-1 to Palo Segment

resource "nsxt_policy_tier1_gateway_interface" "ppd_nic3_router_svcInterface" {
  display_name           = "ppd_nic3_router_svcInterface"
  description            = "Service Connection to Palo t1-atip-bo-stg-nonopt-ext"
  gateway_path           = nsxt_policy_tier1_gateway.ppd_nic3_router.path
  segment_path           = nsxt_policy_segment.ppd_nic3_router_segment.path
  subnets                = ["10.153.12.129/29"]
  #mtu                    = 1500
  #ipv6_ndra_profile_path = data.nsxt_policy_ipv6_ndra_profile.slaac.path
}


## Create Static Route on Palo Tier-1 to Palo VM using Service Interface

resource "nsxt_policy_static_route" "ppd_nic3_router_staticroute" {
  display_name = "ppd_nic3_router_staticroute"
  gateway_path = nsxt_policy_tier1_gateway.ppd_nic3_router.path
  network      = "0.0.0.0/0"

  next_hop {
    admin_distance = "1"
    ip_address     = "10.153.12.131"
	interface      =  nsxt_policy_tier1_gateway_interface.ppd_nic3_router_svcInterface.path
  }
  }


#################################### Nic - 4 #########################################

## Security zone t1-ew-tjs-ppd-mtl-shared-nonopt-local

## Create Palo Tier-1

resource "nsxt_policy_tier1_gateway" "ppd_nic4_router" {
  description           	= "Tier-1 Logical router for security zone t1-ew-tjs-ppd-mtl-shared-nonopt-local "
  display_name          	= "t1-ew-tjs-ppd-mtl-shared-nonopt-local"
  nsx_id          	        = "t1-ew-tjs-ppd-mtl-shared-nonopt-local"
  edge_cluster_path     	= data.nsxt_policy_edge_cluster.edge-cluster.path
  failover_mode         	= "NON_PREEMPTIVE"
  default_rule_logging  	= "false"
  enable_firewall       	= "true"
  enable_standby_relocation = "false"

#   tier0_path            	= data.nsxt_policy_tier0_gateway.tier0_gw_gateway.path
#  route_advertisement_types = [ "TIER1_CONNECTED"]
  pool_allocation       	= "ROUTING"

  tag {
	scope = "security_zone"
	tag   = "t1-ew-tjs-ppd-mtl-shared-nonopt-local"
  }
  
  tag {
	scope = "firewall"
	tag   = "ew-tjs-ppd-mtl-shared-nonopt-local"
 }

}

## Create Palo Segment

resource "nsxt_policy_segment" "ppd_nic4_router_segment" {
  display_name    	= "ls-gne1pc01-pa-ppd01-nic4"
  description     	= "Downlink segment for the security zone under FW-PPD-MONTREAL-1"
  #connectivity_path   = nsxt_policy_tier1_gateway.ppd_nic4_router.path
  transport_zone_path = data.nsxt_policy_transport_zone.overlay_tz.path

  discovery_profile {
    mac_discovery_profile_path = "/infra/mac-discovery-profiles/macdiscovery_profile"
  }
  advanced_config {
	connectivity    = "OFF"
	}
}

## Create Service Interface on PaloTier-1 to Palo Segment

resource "nsxt_policy_tier1_gateway_interface" "ppd_nic4_router_svcInterface" {
  display_name           = "ppd_nic4_router_svcInterface"
  description            = "Service Connection to Palo t1-ew-tjs-ppd-mtl-shared-nonopt-local"
  gateway_path           = nsxt_policy_tier1_gateway.ppd_nic4_router.path
  segment_path           = nsxt_policy_segment.ppd_nic4_router_segment.path
  subnets                = ["10.153.12.177/29"]
  #mtu                    = 1500
  #ipv6_ndra_profile_path = data.nsxt_policy_ipv6_ndra_profile.slaac.path
}


## Create Static Route on Palo Tier-1 to Palo VM using Service Interface

resource "nsxt_policy_static_route" "ppd_nic4_router_staticroute" {
  display_name = "ppd_nic4_router_staticroute"
  gateway_path = nsxt_policy_tier1_gateway.ppd_nic4_router.path
  network      = "0.0.0.0/0"

  next_hop {
    admin_distance = "1"
    ip_address     = "10.153.12.179"
	interface      =  nsxt_policy_tier1_gateway_interface.ppd_nic4_router_svcInterface.path
  }
  }

